#!/usr/bin/env bash
clear

IMAGE_ARCH=$(uname -m)
IMAGE_NAME="undeadgrishnackh/berlin_clock"
IMAGE_TAG="dev"
DOCKER_FILE=./Dockerfile

echo "ğŸ§± Local docker build script to test your flow before going into the CICD"
echo "â„¹ï¸ This script builds a local image based on your laptop architecture"
echo "   architecture detected ğŸ‘‰ ${IMAGE_ARCH}"
echo "_________________________________________________________________________"
echo "ğŸ”§ Building ${IMAGE_NAME} in progress...."
echo ''

if ! hadolint ${DOCKER_FILE}; then
  echo "ğŸ’¥ ğŸ” Docker Linter raised some warnings/errors! Fix them before continuing with the build."; 
  exit 1;
fi
echo "âœ… ğŸ³ Docker Linter passed."
echo "_________________________________________________________________________"
echo ''
set -e

# if the build behaves strangely, try to add --no-cache
if ! docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f Dockerfile . ; then
  echo "ğŸ’¥ ğŸ³ Docker build failed."; 
  exit 1;
fi
echo "âœ… ğŸ³ Docker build passed --> ğŸ‘·ğŸ»â€ ARCH: ${IMAGE_ARCH} ğŸ—ï¸ IMAGE: ${IMAGE_NAME} ğŸ· TAG: ${IMAGE_TAG}"
echo "_________________________________________________________________________"
echo ''


echo "ğŸ‰ it's test time!"
echo "ğŸ§¬ structural test in progress...."
if ! inspec exec ../../tests/release/inspec/dockerfile ; then
  echo "ğŸ’¥ ğŸ³ Inspec test ğŸ§ª failed."; 
  exit 1;
fi
echo "âœ… ğŸ³ Inspec test ğŸ§ª passed."
echo "_________________________________________________________________________"
echo ''

if ! container-structure-test test --config ../../tests/release/container-structure/components.yaml --output text --image ${IMAGE_NAME}:${IMAGE_TAG} ; then
  echo "ğŸ’¥ ğŸ³ Structural ğŸ§ª test failed."; 
  exit 1;
fi
echo ''
echo "âœ… ğŸ³ Structural ğŸ§ª test passed."
echo "_________________________________________________________________________"


echo "ğŸ—œ check container waste efficiency"
CI=true dive $IMAGE_NAME:${IMAGE_TAG}
echo "_________________________________________________________________________"
echo 'ğŸFINISH!'